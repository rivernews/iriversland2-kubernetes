version: 2.1

# yaml basic and advance: https://circleci.com/docs/2.0/writing-yaml/#section=configuration
jobs:
  apply:
    docker:
      - image: shaungc/terraform-kubectl-image
    # environment:
    #   IMAGE_NAME: shaungc/iriversland2-django
    working_directory: ~/terraform
    steps:
      - checkout # retrieves the code from GitHub
      # - run:
      #     name: Setup dynamic environment variables 
      #     # circleci dynammic env, see https://circleci.com/docs/2.0/env-vars/#interpolating-environment-variables-to-set-other-environment-variables
      #     # terraform env, see https://www.terraform.io/docs/configuration/variables.html#environment-variables
      #     command: |
      #       echo 'export TF_VAR_app_container_image="${IMAGE_NAME}"' >> $BASH_ENV
      - run:
          name: Initiate Terraform
          command: |
            chmod +x init-backend-cicd.sh
            sh ./init-backend-cicd.sh
            
      - run:
          name: Plan Terraform
          command: |
            terraform plan
      
      - run:
          name: Check Git Version
          command: |
            git --version
workflows:
  version: 2
  build-master:
    jobs:
      - apply:
          filters:
            branches:
              only: master